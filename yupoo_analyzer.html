<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yupoo Page Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .info {
            color: #3498db;
        }
        .hidden {
            display: none;
        }
        #dropZone {
            border: 2px dashed #3498db;
            padding: 25px;
            text-align: center;
            border-radius: 5px;
            margin: 20px 0;
            cursor: pointer;
        }
        #dropZone.highlight {
            background-color: #ebf5fb;
            border-color: #2980b9;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 0;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>Yupoo Page Analyzer</h1>
    
    <div class="section">
        <h2>1. Load Yupoo Page HTML</h2>
        <p>Drag and drop your saved Yupoo HTML file here or click to select a file:</p>
        <div id="dropZone">
            <p>Drop Yupoo HTML file here or click to select</p>
            <input type="file" id="fileInput" accept=".html,.htm" style="display: none;">
        </div>
        <div id="fileInfo" class="hidden">
            <p>Selected file: <span id="fileName"></span> (<span id="fileSize"></span> bytes)</p>
        </div>
    </div>

    <div class="section">
        <h2>2. Analysis Results</h2>
        <div id="analysisResults">
            <p class="info">Please load a Yupoo HTML file to begin analysis.</p>
        </div>
    </div>

    <div class="section">
        <h2>3. Extracted Data</h2>
        <div id="extractedData">
            <p class="info">No data extracted yet.</p>
        </div>
    </div>

    <script>
        // DOM elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const analysisResults = document.getElementById('analysisResults');
        const extractedData = document.getElementById('extractedData');
        
        let fileContent = '';

        // Event listeners for drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('highlight');
        }

        function unhighlight() {
            dropZone.classList.remove('highlight');
        }

        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            if (!file.type.match('text/html')) {
                showError('Please select an HTML file.');
                return;
            }

            // Update file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');

            // Read file content
            const reader = new FileReader();
            reader.onload = function(e) {
                fileContent = e.target.result;
                analyzeContent(fileContent);
            };
            reader.onerror = function() {
                showError('Error reading the file.');
            };
            reader.readAsText(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showError(message) {
            analysisResults.innerHTML = `<p class="error">${message}</p>`;
        }

        function analyzeContent(content) {
            // Clear previous results
            analysisResults.innerHTML = '';
            extractedData.innerHTML = '';
            
            // Create a temporary div to parse the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // 1. Check for JSON data
            const jsonData = extractJsonData(content);
            const hasJsonData = jsonData !== null;
            
            // 2. Extract album links
            const albumLinks = extractAlbumLinks(tempDiv);
            
            // 3. Extract image URLs
            const imageUrls = extractImageUrls(tempDiv);
            
            // 4. Extract metadata
            const metadata = extractMetadata(tempDiv, content);
            
            // 5. Check for pagination
            const hasPagination = checkPagination(tempDiv);
            
            // Display analysis results
            let resultsHtml = `
                <h3>Analysis Results</h3>
                <div class="result-item">
                    <p><strong>JSON Data:</strong> ${hasJsonData ? '<span class="success">Found</span>' : '<span class="error">Not found</span>'}</p>
                    ${hasJsonData ? '<p>Found album data in JSON format.</p>' : ''}
                </div>
                <div class="result-item">
                    <p><strong>Album Links:</strong> ${albumLinks.length} found</p>
                    ${albumLinks.length > 0 ? `<p>Sample album links: <code>${albumLinks.slice(0, 3).join('</code>, <code>')}</code></p>` : ''}
                </div>
                <div class="result-item">
                    <p><strong>Image URLs:</strong> ${imageUrls.length} found</p>
                    ${imageUrls.length > 0 ? `<p>Sample image URLs: <code>${imageUrls.slice(0, 2).join('</code>, <code>')}</code></p>` : ''}
                </div>
                <div class="result-item">
                    <p><strong>Page Title:</strong> ${metadata.title || 'Not found'}</p>
                    <p><strong>Description:</strong> ${metadata.description || 'Not found'}</p>
                </div>
                <div class="result-item">
                    <p><strong>Pagination:</strong> ${hasPagination ? 'Found' : 'Not found'}</p>
                </div>
            `;
            
            analysisResults.innerHTML = resultsHtml;
            
            // Prepare extracted data for download
            const extractedDataObj = {
                metadata: metadata,
                albumLinks: albumLinks,
                imageUrls: imageUrls,
                hasPagination: hasPagination,
                jsonData: jsonData
            };
            
            // Display extracted data
            const extractedHtml = `
                <h3>Extracted Data</h3>
                <div class="result-item">
                    <h4>Metadata</h4>
                    <pre>${JSON.stringify(metadata, null, 2)}</pre>
                </div>
                <div class="result-item">
                    <h4>Album Links (${albumLinks.length})</h4>
                    <button id="downloadAlbums">Download Album Links</button>
                    <pre>${JSON.stringify(albumLinks.slice(0, 5), null, 2)}${albumLinks.length > 5 ? '\n... and ' + (albumLinks.length - 5) + ' more' : ''}</pre>
                </div>
                <div class="result-item">
                    <h4>Image URLs (${imageUrls.length})</h4>
                    <button id="downloadImages">Download Image URLs</button>
                    <pre>${JSON.stringify(imageUrls.slice(0, 5), null, 2)}${imageUrls.length > 5 ? '\n... and ' + (imageUrls.length - 5) + ' more' : ''}</pre>
                </div>
            `;
            
            extractedData.innerHTML = extractedHtml;
            
            // Add event listeners for download buttons
            document.getElementById('downloadAlbums')?.addEventListener('click', () => {
                downloadFile('yupoo_album_links.json', JSON.stringify(albumLinks, null, 2));
            });
            
            document.getElementById('downloadImages')?.addEventListener('click', () => {
                downloadFile('yupoo_image_urls.json', JSON.stringify(imageUrls, null, 2));
            });
        }
        
        function extractJsonData(content) {
            const jsonMatch = content.match(/<script[^>]*>\s*window\.__INITIAL_STATE__\s*=\s*({.+?})\s*<\/script>/is);
            if (jsonMatch && jsonMatch[1]) {
                try {
                    return JSON.parse(jsonMatch[1]);
                } catch (e) {
                    console.error('Error parsing JSON data:', e);
                }
            }
            return null;
        }
        
        function extractAlbumLinks(element) {
            const links = [];
            const anchorElements = element.querySelectorAll('a[href*="albums/"]');
            
            anchorElements.forEach(anchor => {
                const href = anchor.getAttribute('href');
                if (href && !links.includes(href)) {
                    links.push(href);
                }
            });
            
            return links;
        }
        
        function extractImageUrls(element) {
            const urls = [];
            const imgElements = element.querySelectorAll('img[src]');
            const excludePatterns = [
                /logo/i,
                /icon/i,
                /s\.yupoo\.com\/website\//i,
                /\.(?:svg|gif)$/i
            ];
            
            imgElements.forEach(img => {
                const src = img.getAttribute('src');
                if (src && !urls.includes(src)) {
                    // Check if the URL should be excluded
                    const shouldExclude = excludePatterns.some(pattern => pattern.test(src));
                    if (!shouldExclude) {
                        urls.push(src);
                    }
                }
            });
            
            return urls;
        }
        
        function extractMetadata(element, content) {
            const metadata = {
                title: '',
                description: '',
                keywords: ''
            };
            
            // Extract title
            const titleElement = element.querySelector('title');
            if (titleElement) {
                metadata.title = titleElement.textContent.trim();
            }
            
            // Extract meta description
            const metaDescription = element.querySelector('meta[name="description"]');
            if (metaDescription) {
                metadata.description = metaDescription.getAttribute('content') || '';
            }
            
            // Extract meta keywords
            const metaKeywords = element.querySelector('meta[name="keywords"]');
            if (metaKeywords) {
                metadata.keywords = metaKeywords.getAttribute('content') || '';
            }
            
            return metadata;
        }
        
        function checkPagination(element) {
            const pagination = element.querySelector('.pagination, [class*="pagination"], [id*="pagination"]');
            return pagination !== null;
        }
        
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
